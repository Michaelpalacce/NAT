import { execa } from "execa";
import { ArtifactData } from "../helpers/maven/artifact.js";
import { CliOptions } from "../arguments.js";
import logger from "../logger/logger.js";
import { getCertificates } from "../helpers/fs/locations.js";
import { readFile } from "fs/promises";

/**
* This method runs both vropkg tree and flat. This will package the entire solution to a .package file
* @TODO keypass should be passable or saved
*/
export default async function(args: CliOptions, artifactData: ArtifactData) {
	const { outFolder } = args;
	const { artifactId, groupId, version } = artifactData;
	const start = Date.now();
	const description = "Generated by NAT";

	logger.info("Running vropkg");
	await execa('vropkg', [
		'--in',
		'js',
		'--srcPath', `${outFolder}/vro-sources/js`,
		'--out', 'tree',
		'--destPath', `${outFolder}/vro-sources/xml`,
		'--privateKeyPEM', getCertificates().privateKeyPem,
		'--certificatesPEM', getCertificates().certPem,
		'--keyPass', (await readFile(getCertificates().certPass)).toString(),
		'--version', version,
		'--packaging', 'package',
		'--artifactId', artifactId,
		'--groupId', groupId,
		'--description', description,
	]);
	await execa('vropkg', [
		'--in', 'tree',
		'--srcPath', `${outFolder}/vro-sources/xml`,
		'--out', 'flat',
		'--destPath', `${outFolder}/vropkg`,
		'--privateKeyPEM', getCertificates().privateKeyPem,
		'--certificatesPEM', getCertificates().certPem,
		'--keyPass', (await readFile(getCertificates().certPass)).toString(),
		'--version', version,
		'--packaging', 'package',
		'--artifactId', artifactId,
		'--groupId', groupId,
		'--description', description,
	]);
	logger.info(`Finished running vropkg: Took: ${(Date.now() - start) / 1000}s`);
}
